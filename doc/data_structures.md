cleantools Data Structures
==========================

STRUCTURE OF THE CLN STRUCTURE
------------------------------
CLEANFLUX produces a source structure which is automatically stored as a HIhhmmss.s+ddmmss.src file in the directory you are 
working in. The structure of cln is similar to the src structure generated by GALFLUX however, there is an additional tag that 
stores information about the deconvolution.  Thus, the cln structure is fully compatible with the src structure and, as such, 
is stored with the variable name `src`.  The structure of cln is as follows:

```
IDL> restore,'HI123451.2+153250_1236+15a.src'
IDL> help,src,/struct
** Structure <9caa084>, 6 tags, length=339584, data length=339536, refs=1:
   SRCNAME	STRING	'123451.2+153250'
   GRIDGEN	STRUCT	-> <Anonymous> Array[1]
   SRCCUBE	STRUCT	-> <Anonymous> Array[1]
   CLNCTRL	STRUCT	-> <Anonymous> Array[1]
   SPECTRA	STRUCT	-> <Anonymous> Array[7]
   COMMENTS	STRING	Array[2]
```

where SRCNAME is the name of the source and COMMENTS is the character string you input during CLEANFLUX. The gridgen substructure 
contains information on the grid of origin of the source measured as shown below:

```
IDL> help,src.gridgen,/struct
** Structure <9c58afc>, 13 tags, length=8680, data length=8680, refs=2:
   NAME		STRING	'1236+15'
   NXPIX		LONG		29
   NYPIX		LONG		25
   NCHN		LONG		1024
   RAHR		DOUBLE	Array[29]
   DECDEG		DOUBLE	Array[25]
   VELARR		DOUBLE	Array[1024]
   DELTARA		DOUBLE	4.1411048
   DELTADEC		DOUBLE	1.0000000
   BOX_LLX		LONG		7
   BOX_LLY		LONG		7
   BOX_URX		LONG		19
   BOX_URY		LONG		18
```

where the BOX_LLX is the x position of the lower-left hand corner of the flux box, etc. The other parameters describe the 
spatial and spectral dimensions of the flux box.

The srccube substructure contains a 3-d "postage stamp" of the source, a data cube containing the spectra (as chosen by the 
flux box), restricted via the spectral stretch chosen for ellipse fitting.  In the case of the cln structure, this information 
is of the *deconvolved* data rather than the raw data as is the case with a GALFLUX src structure.  The srccube substructure 
is:

```
IDL> help,src.srccube,/struct
** Structure <9d1325c>, 15 tags, length=52524, data length=52522, refs=2:
   NBX			LONG		13
   NBY			LONG		12
   NBZ			INT		26
   RABOX		DOUBLE	Array[13]
   DECBOX		DOUBLE	Array[12]
   VELBOX		DOUBLE	Array[26]
   DBOX		DOUBLE	Array[26, 13, 12]
   WBOX		FLOAT		Array[26, 13, 12]
   CBOX		DOUBLE	Array[13, 12]
   RACEN		DOUBLE	Array[26]
   DECCEN		DOUBLE	Array[26]
   RAPEAK		DOUBLE	Array[26]
   DECPEAK		DOUBLE	Array[26]
   PEAKVAL		FLOAT		Array[26]
   TOTF			DOUBLE	Array[13, 12]
```

The spectral intensities are in DBOX, and the corresponding weights are in WBOX.  The array CBOX contains the continuum fluxes 
and the array TOTF contains the integrated spectral fluxes of each pixel. The other parameters describe the spatial and 
velocity extent of the box as well as the locations in right accession and declination of where the peaks in the flux density lie.

The clnctrl substructure contains the parameters used to carry out and control the deconvolution.  This substructure is unique 
to cln and CLEANFLUX.  It is as follows:

```
IDL> help,src.clnctrl,/struct
** Structure <9c75974>, 11 tags, length=125184, data length=125180, refs=2:
   BOX			LONG		Array[4]
   ROBUST_RMS	FLOAT		3.28473
   FLUX_LIMIT		FLOAT		0.00000
   SIGMA_LIMIT	FLOAT		5.00000
   NITER_LIMIT		LONG		2000
   CHAN_RANGE	LONG		Array[2]
   COMBINE_CHAN	INT		0
   CLEAN_LOG		STRING	Array[10001]
   EXIT_STATUS	INT		Array[3]
   BEAM		DOUBLE	Array[25, 25]
   BEAM_LOG		STRING	Array[10]
   RESTORE_FWHM	DOUBLE	Array[2]
   RESTORE_PA           DOUBLE	-90.000000
```

where BOX gives the size of the box used for cleaning.  This BOX should always be larger than the box used to measure 
the flux.  BEAM and BEAM_LOG give the beam shape and the messages that result from modeling the beam.  The BEAM is computed 
for the center of the BOX by build_beam5 and is either 21', 25', 31', 35', 41', 45', or 51' on a side.  BEAM_LOG gives the 
details of how the effective beam was modeled and its log looks like:  

```
build_beam5 started:
> setup 
>  using 3 drifts 
>  drifts south of zenith
> observe 
>  beam positional error +0.15 +/- 0.97 arc sec 
> map 
> reduce
> total time 7.6739049 seconds
```

where the important pieces of information in this log are the number of drifts used in modeling,  whether the drift is north 
or south of zenith (determined from the azimuth arm angle), and the positional error that comes from projecting the drift 
centers onto a discrete grid.  For details of the modeling process see BUILD_BEAM5.

The remaining tags deal with how the channels are cleaned.  ROBUST_SIGMA gives the sky RMS computed for the grid using the 
ROBUST_SIGMA routine from the GSFC's IDL Astronomy User's Library.  This is used, along with FLUX_LIMIT and SIGMA_LIMIT, to 
help determine the flux density to which each channel should be cleaned.  NITER_LIMIT supplements these tags and cuts off 
cleaning after a determined number of iterations.  CHAN_RANGE and COMBINE_CHAN determine which channels are cleaned.  CHAN_RANGE 
is a two-element array that contains the start and stop channels of the deconvolution.  COMBINE_CHAN is set to 1 if the routine 
is allowed to combine adjacent channels into wider pseudo-channels to improve the signal-to-noise ratio.  This is turned off 
(0) by default but can be enabled in CLEANVIEW.

The final two tags give insight into how the channels where cleaned.  EXIT_STATUS is a three-element array that gives a tally 
of total number of channels where the deconvolution was halted.  The elements are (0) the number halted by the iteration 
limit in NITER_LIMIT and (1) the number halted by the flux density limit of max([FLUX_LIMIT, SKY_RMS*SIGMA_LIMIT]).  CLEAN_LOG 
is the verbose version of EXIT_STATUS and gives a channel-by-channel summary of the deconvolution.  This log looks like:

```
alfa_clean7 started: 
> setup 
>  loaded 1024x 29x 25 data cube 
> clean
>  cleaning data cube to a peak flux of 16.4236 mJy or 2000 iterations
...
>  Channel  378 
>  exiting on flux limit 
>   used 137 iterations
>   peak at loop exit 16.411306 mJy 
>   residual RMS is 2.5879821 mJy
...
> restore
>  using Gaussian with 4.60'x3.10’ FWHM 
>  clean map flux 580.43608 Jy
>  residual flux  2227.2016 Jy 
>  total flux     2807.6377 Jy
>  input flux     2807.6377 Jy 
> clean
>  cleaning continuum map to a peak flux of 16.4236 mJy or 2000 iterations
>  Continuum Map 
>  exiting on flux limit 
>   used 179 iterations
>   peak at loop exit 16.402602 mJy 
>   residual RMS is 3.4344689 mJy 
> restore
>  using  Gaussian with 4.60'x3.10’ FWHM
>  clean continuum map flux 0.29667021 Jy 
>  residual flux  3.8220691 Jy
>  continuum total flux     4.1187393 Jy 
>  input flux     4.1187393 Jy
> total time 23.895307 seconds
```

There are four important sections to this log: the channel clean detail, the channel restore detail, the continuum clean detail, 
and the continuum restore detail.  The first is the channel-by-channel summary of how the frame was cleaned.  This is composed 
of five lines.  The first gives the channel (or pseudo-channel if COMBINE_CHANS is set to 1) number. The second contains what 
condition caused the cleaning process to exit (flux limit, iteration limit, or residuals limit).  The next line gives the 
number of iterations used in cleaning.  For channels with no peaks about the flux density thresholds set by FLUX_LIMIT and 
SIGMA_LIMIT this value is 1.  The fourth line gives the flux density of the last peak cleaned.  These two lines are particularly 
useful in determining to what depth each channel should be cleaned.  The final line gives the RMS of the remaining (un-cleaned) 
component of the channel.  For a well cleaned channel, this value should be comparable to the value stored in ROBUST_RMS.  

The channel restore detail gives details about what happens after each channel has been cleaned.  Once cleaned, each channel 
has two components, the cleaned component and the residuals component.  The residuals map contains only what could not be 
cleaned by the beam, i.e., sky noise.  In order to combine these two together again, the cleaned component needs to be convolved 
with a restore beam that is roughly the same size as the effective beam found in the data.  Based on the beam size of Arecibo 
and readings on Högbom (1974) I choose a 3' circular Gaussian as the best match (given on the first line of this section of the 
log).  The other lines in this section give a breakdown of the flux in the two components and compare the before and after 
fluxes for a sanity check.

The remaining two sections deal with the continuum map and have identical outputs to the channel maps.

The fourth substructure is the most complicated. It is actually an array of substructures - one element for each isophotal level 
for which a CLEANFLUX measurement was made. The first element is always that for the half power ellipse, the second for the 
quarter power, the third for the 100 mJy, and then 200, 300, 500, 1000 (if available: the number of elements of the src.spectra 
array is variable). For each
element of the subarray:

```
IDL> help,src.spectra,/struct
** Structure <8380044>, 98 tags, length=21880, data length=21874, refs=2:
   NAME		STRING	'123451.2+153250'
   AGCNR		STRING	'7742'
   AGCNAME 		STRING	'N4540'
   NGC			STRING	''
   IC			STRING	''
   TWOMASS		STRING	''
   SDSS		STRING	''
   OTHER		STRING	''
   TYPE			STRING	'integrated'
   COORD_EPOCH	STRING	'2000'
   ISOPHOT		FLOAT		2986.79
   RA_CENTROID	DOUBLE 	12.580877
   DEC_CENTROID	DOUBLE	15.572923
   RA_ELL		DOUBLE 	12.581084
   DEC_ELL		DOUBLE	15.543379
   A_ELL		FLOAT 		3.88575
   B_ELL		FLOAT		2.79544
   PA_ELL		FLOAT		-110.301
   NPIX_ELL		LONG 		9
   MAP_MAXFLX	DOUBLE	5973.5819
   RA_OPT		DOUBLE	Array[1]
   DEC_OPT		DOUBLE	Array[1]
   FEED			LONG		0
   STRIP		LONG		0
   NREC		LONG		0
   NPOL		LONG		3
   D_FILE		LONG		Array[3]
   NCHN		LONG		1024
   CEN_F		FLOAT		0.00000
   CEN_V		FLOAT		0.00000
   RESTFRQ		FLOAT           	1420.41
   CEN_CH		LONG		0
   CH_FWIDTH		DOUBLE	0.024414060
   HELIOVELPROJ 	DOUBLE 	0.0000000
   NCHLO		INT           	371
   NCHHI		INT          	396
   VCEN 		FLOAT     	Array[8]
   VCENERR_STAT	FLOAT     	Array[8]
   VCENERR_SYS	DOUBLE    	Array[8]
   WIDTH		FLOAT     	Array[8]
   WIDTHERR		DOUBLE    	Array[8]
   PKS_NCH		FLOAT     	Array[2]
   PKS_FLX		FLOAT     	Array[2]
   SLOPE_COEFF_LO	FLOAT     	Array[3]
   SLOPE_COEFF_HI	FLOAT     	Array[3]
   MSR_MODES	STRING    	Array[8]
   MEAN_FLX		FLOAT           	47.4733
   PEAK_FLX		FLOAT     	Array[2]
   PEAK_FLX_CH	LONG             	0
   FLUX_INT_MAP	FLOAT		6583.04
   FLUX_MAP_ERR_STAT	FLOAT		0.00000
   FLUX_MAP_ERR_SYS	FLOAT		0.00000
   FLUX_INT_SPECP		FLOAT		6661.66
   FLUX_SPECP_ERR_STA	FLOAT		72.7693
   FLUX_SPECP_ERR_SYS	DOUBLE	0.0000000
   FLUX_INT_SPECG		FLOAT		0.00000
   FLUX_SPECG_ERR_STAT	FLOAT		0.00000
   FLUX_SPECG_ERR_SYS	DOUBLE	0.0000000
   PEAK_ABS		FLOAT		0.00000
   PEAK_ABS_ERR	FLOAT		0.00000
   TAUDV_INT		FLOAT		0.00000
   TAUDV_INT_ERR	FLOAT           	0.00000
   CONTINUUM		FLOAT           	17.9339
   RMSP		FLOAT           	2.74594
   RMSG		FLOAT           	0.00000
   STON		FLOAT     	Array[8]
   SMO			INT              	3
   DETCODE		INT       	Array[4]
   GRID_NAME		STRING    	'1236+15'
   GRID_MODE		STRING    	'Gauss'
   GRID_PARMS	FLOAT     	Array[4]
   GRID_SMO		LONG		3
   GRID_DELTARA	DOUBLE	4.1411048
   GRID_DELTADEC	DOUBLE	1.0000000
   PHOT_MODE	INT              	3
   PHOT_NPIX		LONG		9
   PHOT_BOX		LONG      	Array[4]
   PHOT_RAD		FLOAT           	0.00000
   PHOT_ELL_A	FLOAT           	3.88575
   PHOT_ELL_B	FLOAT           	2.79544
   PHOT_ELL_PA	FLOAT          	-110.301
   BASELINE		DOUBLE    	Array[12]
   XMIN			FLOAT           	0.00000
   XMAX		FLOAT           	0.00000
   YMIN			FLOAT          	-185.500
   YMAX		FLOAT           	556.500
   YUNITS		INT              	0
   X_INT		LONG      	Array[16]
   X_FLT		FLOAT     	Array[16]
   X_DBL		DOUBLE    	Array[8]
   X_STR		STRING    	Array[16]
   COMMENTS		STRING    	'Cleaned with CLEANview'
   DATE_OF_RED	STRING    	'Mon May 19 16:17:43 2008'
   NAME_OF_RED	STRING    	'e.g. BK'
   MJD			DOUBLE	0.0000000
   VELARR		DOUBLE 	Array[1024]
   SPEC		DOUBLE	Array[1024]
   WEIGHT		FLOAT		Array[1024]
```

The contents of which are too lengthy to describe individually here. See the GALFLUX/CLEANFLUX code for details. There are 
three important arrays: the spectral intensities (src.spectra.spec), the correpsonding weights (src.spectra.weight) and 
velocities (spec.spectra.velarr).

The Data Saved by the CleanView "File->Save Data" Operation
-----------------------------------------------------------
CLEANVIEW has an option to save the intermediate deconvolution products to an IDL sav file for analysis outside of 
CLEANVIEW/CLEANFLUX.  This sav files contains three variables:  cleand (the deconvolved spectral map), c_cleand (the 
deconvolved continuum map), and cleanstate.  The structure of the cleanstate variable is documented below:  

```
IDL> restore, ’cleanview.sav’
IDL> help ,cleand, c_cleand, cleanstate, /struct
CLEAND          	DOUBLE    = Array[1024, 17, 16]
C_CLEAND      	DOUBLE    = Array[17, 16]
** Structure <a13e08>, 21 tags, length=8133872, data length=8133862, refs=1:
   LLX             		LONG               	56
   LLY             		LONG               	35
   URX             		LONG		72
   URY             		LONG		50
   MAP_BUFFER     	INT		6
   BEAM            		DOUBLE	Array[29, 28, 35, 35]
   BEAMLOG         	STRING	Array[477]
   RMS             		FLOAT		3.27460
   FLUX            		FLOAT		0.00000
   SIGMA           	FLOAT 		1.00000
   NITER           		LONG		1000
   CRANGE          	LONG		Array[2]
   ALLOWSUM        	INT		0
   RESTORE_FWHM    FLOAT		Array[2]
   RESTORE_PA      	FLOAT		1.84700
   AREA_CORR       	DOUBLE	Array[29, 28]
   CLEANLOG        	STRING	Array[5150]
   CLEANEXIT       	INT		Array[1024]
   CLEANSUM        	INT		Array[2]
```

The values LLX, LLY, URY, and URY define the corners of the grid region that has been deconvolved and stored in cleand and 
c_cleand.  MAP_BUFFER stores the amount of buffering applied to the LLX, LLY, URX, and URY boundaries to deal with bright 
sources near the edge of the region to be cleaned.  The buffering shown above of 6’ is large enough to include sidelobe 
contributions  down to the 5% level.

BEAM is a 4-D array that stores the effective beam pattern for each point in the region that is cleaned.  The dimensions on 
this array are RA, dec., Beam RA, and Beam dec.  Thus, the beam at map point (i,j) is given by cleanstate.beam[(i-llx), (j-lly), *, *].
Note:  In all cases, the RA and dec. extent of BEAM is larger than that of cleand and c_cleaned.  This is due to the padding 
specified in MAP_BUFFER.  BEAMLOG stores information about the beam modeling process for each beam.  The number of elements in 
this array changes from source to source, based on the number of beams used in the cleaning process.

The next six tags describe how the cleaning was carried out.  RMS stored the sky RMS found by cleanview.  FLUX and SIGMA are 
used to specify the flux density limit to clean down to via max([FLUX, SIGMA*RMS]).  NITER stores the maximum number of 
iterations to use in cleaning each channel, while CRANGE is a two-element array which stores the first and last channels to 
clean.  

RESTORE_FWHM, RESTORE_PA, and AREA_CORR store information about the restore step of CLEAN.  RESTORE_FWHM and RESTORE_PA 
contain the FWHM and position angle of the Gaussian restore beam and are based off a fit to the inner 11' of the beam at CX, CY.  
AREA_CORR stores a correction for the flux density that is needed to convert between mJy/"dirty" beam to mJy/"clean" beam.  
This factor is applied to the data via

```
clean_flux = dirty_flux / AREA_CORR.
```

The final three tags store information about how each details about the contents of these tags are given in Section 1 where 
the src.clnctrl sub-structure is discussed.
